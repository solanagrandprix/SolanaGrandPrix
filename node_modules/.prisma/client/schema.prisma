datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "windows", "linux-musl-openssl-3.0.x"]
}

model User {
  id              Int              @id @default(autoincrement())
  username        String           @unique
  passwordHash    String
  isAdmin         Boolean          @default(false)
  driver          Driver?
  deletionRequest DeletionRequest?
  iracingAccount  IracingAccount?
  createdAt       DateTime         @default(now())
  // updatedAt temporarily removed - column doesn't exist in database
  // updatedAt         DateTime @updatedAt
}

model Driver {
  id     Int  @id @default(autoincrement())
  userId Int  @unique
  user   User @relation(fields: [userId], references: [id])

  driverKey   String @unique
  displayName String

  number     Int    @default(0)
  team       String @default("Privateer")
  primaryCar String @default("Mazda MX-5 Cup")
  avatar     String @default("/images/default-avatar.png")

  irating   Int     @default(0)
  license   String  @default("Rookie")
  starts    Int     @default(0)
  freeAgent Boolean @default(true)

  xpTotal    Int    @default(0)
  xpLevel    Int    @default(1)
  xpToNext   Int    @default(500)
  skillTier  String @default("Beginner")
  bestFinish Int    @default(0)
  winRate    Float  @default(0)
  totalPurse Int    @default(0)

  preferredClasses  String?
  country           String?
  timezone          String?
  twitch            String?
  twitter           String?
  discord           String?
  iracing           String? // iRacing username/ID for API connection
  solanaWallet      String? // Solana wallet address (base58 encoded public key)
  driverNotes       String?
  cardCustomization String? // JSON string storing card customization settings

  achievements Achievement[] // Achievements unlocked by this driver

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Achievement {
  id          Int     @id @default(autoincrement())
  name        String
  description String
  icon        String? // Emoji or icon identifier
  xpReward    Int     @default(0) // XP awarded when unlocked
  rarity      String  @default("Common") // Common, Rare, Epic, Legendary
  category    String? // e.g., "Racing", "Social", "Milestone"
  isActive    Boolean @default(true) // Whether this achievement is currently available

  driverId Int? // If null, this is a global achievement template
  driver   Driver? @relation(fields: [driverId], references: [id])

  unlockedAt DateTime? // When this achievement was unlocked (null for templates)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model DeletionRequest {
  id     Int  @id @default(autoincrement())
  userId Int  @unique
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)

  reason     String? // Optional reason provided by user
  status     String    @default("pending") // pending, approved, denied
  reviewedBy Int? // Admin user ID who reviewed the request
  reviewedAt DateTime?
  notes      String? // Admin notes about the review

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model CalendarEvent {
  id          Int      @id @default(autoincrement())
  title       String
  description String?
  eventDate   DateTime // Date and time of the event
  eventType   String   @default("race") // race, practice, qualifier, special, etc.
  track       String?
  carClass    String?
  status      String   @default("scheduled") // scheduled, completed, cancelled, postponed
  isActive    Boolean  @default(true)
  createdBy   Int? // Admin user ID who created the event
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// iRacing OAuth account connection
// PRIVACY NOTE: displayName is the user's iRacing username/display name (user-chosen), NOT their real name.
// Only returned to the authenticated user viewing their own account status, never exposed publicly.
model IracingAccount {
  id     Int  @id @default(autoincrement())
  userId Int  @unique
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)

  custId       Int      @unique // iRacing customer ID
  accessToken  String // Encrypted or stored securely
  refreshToken String
  expiresAt    DateTime // Token expiration time
  // PRIVACY: displayName is iRacing username (user-chosen), NOT real name. Only visible to account owner.
  displayName  String? // iRacing username/display name (cached, user-chosen, NOT real name)

  lastSyncedAt DateTime? // Last time sessions were synced
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
}

// iRacing session data (league or hosted practice sessions)
model IracingSession {
  id        Int    @id @default(autoincrement())
  sessionId String @unique // iRacing session ID

  sessionType String // practice, race, qualifying
  leagueId    Int? // iRacing league ID (if league session)
  leagueName  String? // League name (cached)
  trackName   String
  carName     String
  startTime   DateTime

  // Additional metadata
  subSessionId Int? // Sub-session ID for multi-session races
  seasonId     Int? // Season ID if part of a series

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  participants IracingSessionParticipant[]
}

// Participants in iRacing sessions
// PRIVACY NOTE: displayName is stored for internal tracking but is NOT exposed in public APIs.
// displayName is the iRacing username/display name (user-chosen), NOT real names.
// Only session stats (laps, times, incidents, positions) are exposed, not participant identities.
model IracingSessionParticipant {
  id        Int            @id @default(autoincrement())
  sessionId String
  session   IracingSession @relation(fields: [sessionId], references: [sessionId], onDelete: Cascade)

  custId      Int // iRacing customer ID
  // PRIVACY: displayName stored internally but NOT exposed in API responses
  displayName String // iRacing username/display name at time of session (user-chosen, NOT real name)

  lapsCompleted Int    @default(0)
  bestLapTime   Float? // Best lap time in seconds (null if no lap completed)
  incidents     Int    @default(0) // Total incidents (if available)

  // Additional stats (if available)
  finishPosition   Int? // Finish position (if race completed)
  startingPosition Int? // Starting position
  totalLaps        Int? // Total laps (may differ from lapsCompleted)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([sessionId, custId]) // One record per participant per session
  @@index([custId]) // Index for querying by customer ID
}
